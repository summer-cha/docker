{
  "schemaVersion": 2,
  "services": [
    {
      "name": "config-generator",
      "image": "alpine:latest",
      "command": [
        "sh",
        "-c",
        "if [ -f /shared/config.yaml ] && [ -f /shared/.generated ]; then echo 'Config already exists, exiting...'; exit 0; fi; printf 'verbosity: 0\\nport: 8190\\nstreams:\\n  - name: %s\\n    source: %s\\n    resolution: %s\\n    quality: %s\\n    framerate: %s\\n' \"$CAMERA_NAME\" \"$RTSP_SOURCE\" \"$RESOLUTION\" \"$QUALITY\" \"$FRAMERATE\" > /shared/config.yaml && echo 'Configuration generated successfully:' && cat /shared/config.yaml && touch /shared/.generated && sleep 5"
      ],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data",
          "containerPath": "/shared"
        }
      ],
      "environment": [
        {
          "key": "CAMERA_NAME",
          "value": "${CAMERA_NAME}"
        },
        {
          "key": "RTSP_SOURCE",
          "value": "${RTSP_SOURCE}"
        },
        {
          "key": "RESOLUTION",
          "value": "${RESOLUTION}"
        },
        {
          "key": "QUALITY",
          "value": "${QUALITY}"
        },
        {
          "key": "FRAMERATE",
          "value": "${FRAMERATE}"
        }
      ]
    },
    {
      "name": "wyze-mjpeg-proxy",
      "image": "kamermans/wyze-mjpeg-proxy:latest",
      "isMain": true,
      "internalPort": 8190,
      "dependsOn": {
        "config-generator": {
          "condition": "service_completed_successfully"
        }
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/config.yaml",
          "containerPath": "/config.yaml",
          "readOnly": true
        }
      ]
    }
  ]
}
